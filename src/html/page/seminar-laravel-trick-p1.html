<!-- build:title -->Seminar: Nghịch phá một số thứ linh tinh cùng Laravel (Phần 1)<!-- /build:title -->

<!-- build:menu --><div class="navbar-fixed home-bg"><!-- /build:menu -->

<!-- build:quotes -->
<div class="navbar-quotes-content">
    It's only terrible to have nothing to wait for.
</div>
<div class="navbar-quotes-speaker">
    Erich Maria Remarque
</div>
<!-- /build:quotes -->

<!-- build:body -->
<h1>Seminar: Nghịch phá một số thứ linh tinh cùng Laravel  (Phần 1)</h1>
<div class="home-content">
	<div class="blog-detail">
		<div class="blog-detail-date">Đăng lúc 11/04/2019</div>
		<div class="tags">
            <span><a href="tags.html?tag=laravel">laravel</a></span>
            <span><a href="tags.html?tag=seminar">seminar</a></span>
		</div>
        <!-- <h4>Mở đầu</h4>
        <p>Một số trò mèo có thể nghịch khi làm việc với <b>Laravel</b></p>
        <ul>
            <li>
                Chạy nhiều dự án với Laradock
            </li>
            <li>
                Chạy một ngrok cho nhiều dự án
            </li>
            <li>
                Tinker - một đồng sự tuyệt vời.
            </li>
            <li>
                Debugbar, một thiên tài tình báo
            </li>
            <li>
                Debug với Slack, tại sao không?
            </li>
            
        </ul> -->
        <ul class="series">
            <li>Các bài viết trong series</li>
            <li><a class="current" href="seminar-laravel-trick-p1.html">Chạy nhiều dự án với Laradock</a></li>
            <li><a href="seminar-laravel-trick-p2.html">Chạy một ngrok cho nhiều dự án</a></li>
            <!-- <li><a href="toi-da-den-voi-javascript-nhu-the-nao-p3.html">First love</a></li>
            <li><a href="toi-da-den-voi-javascript-nhu-the-nao-p4.html">New Deal</a></li>
            <li><a href="toi-da-den-voi-javascript-nhu-the-nao-p5.html">Nhân sinh hà xứ bất tương phùng</a></li> -->
        </ul>
        <h4>Chạy nhiều dự án với Laradock</h4>
        <p>Trên trang chủ của <a href="https://laradock.io/">Laradock</a> chúng ta có thể thấy các bước cơ bản để chạy một dự án với môi trường cơ bản (PHP, Nginx, mysql...) như sau (có thể bỏ qua nếu bạn đã hiểu các công việc này):</p>
        <ul>
            <li>Clone repository của Laradock vào bên trong dự án.</li>
            <li>Tạo file <i>.env</i> từ file <i>env-example</i></li>
            <li>Chạy các container và build các image bạn cần (theo trang chủ thì là mysql, redis, nginx, phpmyadmin, workspace)</li>
            <li>Sau khi đã chạy xong, chúng ta thay đổi các thông số trong trong <i>.env</i> của dự án Laravel nhằm kết nối với Queue, Redis và Mysql</li>
            <li>Bước cuối là vào <i>http://localhost</i> để tận hưởng thành quả thôi.</li>
        </ul>
        <p>Theo các bước trên thì chúng ta có thể chạy một dự án Laravel mà không cần quan tâm đến việc cài đặt môi trường. Nhưng lấy ví dụ như giờ chúng ta có nhiều dự án Laravel cần chạy thì sao? Phương án đầu tiên cũng là đơn giản nhất là lặp lại các bước trên với mỗi dự án. Nhưng cách này bộc lộ một số hạn chế như sau:</p>
        <ul>
            <li>Các image và container sẽ bị lặp lại dẫn đến hiệu năng không tốt cho thiết bị. Ví dụ như nginx hay mysql chúng ta hoàn toàn có thể dùng chung.</li>
            <li>Nếu dùng theo kiểu micro service thì một số trường hợp phải cần dùng chung database.</li>
        </ul>
        <p>Đương nhiên tất cả các vấn đề trên đều có thể giải quyết được với nhiều <b>Laradock</b>. Nhưng do mình rãnh nên mình sẽ viết cách để dùng các image cơ bản kia cho nhiều product (chung mysql, redis và chạy trên một con nginx với mỗi project sẽ là một port khác nhau).</p>
        <p>Để có thể hiểu rõ hơn thì thay vì đi thẳng vào cài đặt từ đầu mình sẽ nói sơ qua về các cấu hình trong file <i>docker-compose.yml</i> và các key trong file <i>.env</i> của nginx. Cùng ngó qua phần nginx của file <i>docker-compose.yml</i> nào:</p>
<pre><code class="yml">
    nginx:
      build:
        context: ./nginx
        args:
          - PHP_UPSTREAM_CONTAINER=${NGINX_PHP_UPSTREAM_CONTAINER}
          - PHP_UPSTREAM_PORT=${NGINX_PHP_UPSTREAM_PORT}
          - CHANGE_SOURCE=${CHANGE_SOURCE}
      volumes:
        - ${APP_CODE_PATH_HOST}:${APP_CODE_PATH_CONTAINER}${APP_CODE_CONTAINER_FLAG}
        - ${NGINX_HOST_LOG_PATH}:/var/log/nginx
        - ${NGINX_SITES_PATH}:/etc/nginx/sites-available
        - ${NGINX_SSL_PATH}:/etc/nginx/ssl
      ports:
        - "${NGINX_HOST_HTTP_PORT}:80"
        - "${NGINX_HOST_HTTPS_PORT}:443"

</code></pre>
    <p>Còn đây là trong giá trị trong file <i>.env</i></p>
<pre><code class="apache">
    ### NGINX #################################################

    NGINX_HOST_HTTP_PORT=80
    NGINX_HOST_HTTPS_PORT=443
    NGINX_HOST_LOG_PATH=./logs/nginx/
    NGINX_SITES_PATH=./nginx/sites/
    NGINX_PHP_UPSTREAM_CONTAINER=php-fpm
    NGINX_PHP_UPSTREAM_PORT=9000
    NGINX_SSL_PATH=./nginx/ssl/
    APP_CODE_PATH_HOST=../
    APP_CODE_PATH_CONTAINER=/var/www

</code></pre>
        <p>Ở đây mình sẽ giải thích sơ về hai phần là <b>ports</b> và <b>volumes</b>. Như đã thấy ở phần ports thì có thể dễ dàng nhận ra port 80 của nginx (trong docker) đang trỏ thẳng ra port 80 ở "ngoài". Đồng nghĩa vào localhost trong nginx cũng sẽ là localhost ở ngoài. Vậy cái port 80 đó trỏ đến gì nhỉ? Để giải đáp chúng sẽ mở file default.conf của nginx ra để xem. Nhưng mà file đó ở đâu nhỉ? À trong thư mục <i>/etc/nginx/sites-available</i>. Vào container nginx để xem nội dung nào. Nhưng mà khoan đã... hãy nhìn lại trong file <i>docker-compose.yml</i> và file <i>.env</i> nào. Trong mục volumes chúng ta có thể thế có dòng <i>- ${NGINX_SITES_PATH}:/etc/nginx/sites-available</i>. Điều này chứng tỏ là thư mục sites-available đã được mount ra ngoài, nơi chứa là  ở NGINX_SITES_PATH. Mở file <i>.env</i> ra chúng ta có thể thấy địa chỉ đó là <i>./nginx/sites/</i>. Thử mở địa chỉ đó ra nào:</p>

<pre><code class="shell">
    laradock admin$ ls ./nginx/sites/
    app.conf.example        default.conf            laravel.conf.example    symfony.conf.example

</code></pre>
        <p>Thì ra người anh em <i>default.conf</i> đã cư ngụ ở đây. Đỡ tốn công chui vào container. Để xem file đó viết gì nào:</p>
<pre><code class="nginx">
    server {

        listen 80 default_server;
        listen [::]:80 default_server ipv6only=on;
    
        # For https
        # listen 443 ssl default_server;
        # listen [::]:443 ssl default_server ipv6only=on;
        # ssl_certificate /etc/nginx/ssl/default.crt;
        # ssl_certificate_key /etc/nginx/ssl/default.key;
    
        server_name localhost;
        root /var/www/public;
        index index.php index.html index.htm;
    
        location / {
                try_files $uri $uri/ /index.php$is_args$args;
        }
    
        location ~ \.php$ {
            try_files $uri /index.php =404;
            fastcgi_pass php-upstream;
            fastcgi_index index.php;
            fastcgi_buffers 16 16k;
            fastcgi_buffer_size 32k;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            #fixes timeouts
            fastcgi_read_timeout 600;
            include fastcgi_params;
        }
    
        location ~ /\.ht {
            deny all;
        }
    
        location /.well-known/acme-challenge/ {
            root /var/www/letsencrypt/;
            log_not_found off;
        }
    }
</code></pre>
        <p>Thì ra port 80 của chúng ta đang trỏ vào thư mục <i>/var/www/public</i> với các file index được chỉ định là <i>index.php</i>. Đã biết được vị trí mà port 80 trỏ vào rồi giờ chúng ta truy tìm xem thư mục đó chứa gì nào. Dựa theo dấu vết từ file <i>default.conf</i> chúng ta quay trở lại file <i>docker-compose.yml</i>. Nhưng khi mở ra file lại thì lại không thấy folder <i>/var/www/public</i> ở đâu cả. Nhưng trong mục volumes có một thanh niên rất khả nghi đó là: </p> 
<pre><code class="yml">
    - ${APP_CODE_PATH_HOST}:${APP_CODE_PATH_CONTAINER}${APP_CODE_CONTAINER_FLAG}

</code></pre>
        <p>Kiểm tra trong file <i>.env</i> chúng ta có thể thấy rằng ${APP_CODE_PATH_HOST} chính ra cấp ngoài thư mục của laradock (../). Thư mục public mà nginx đề cập tới chính là thư mục public của dự án Laravel (hèn gì bọn nó nói mình phải clone Laradock bên trong lòng dự án Laravel, hehe.</p>
        <p>Sau khi đã đi qua một vòng rồi mình sẽ tóm tắt lại như sau: Nginx sẽ mở một port 80 trỏ vào thư mục public của <i>/var/www/</i>. Đồng thời thư mục trên lại chính là thư mục Laravel ở ngoài. Như vậy muốn chạy nhiều dự án như mục tiêu ban đầu thì sao? Theo cách của mình thì sẽ làm như sau:</p>
        <p>Thứ nhất tạo một thư mục là <i>projects</i> hoặc <i>codes</i> tuỳ các bạn. Đặt cùng cấp với thư mục laradock. Các dự án sẽ được clone vào trong thư mục này theo dạng các thư mục con đồng cấp.</p>
        <p>Sau đó vào file <i>.env</i> sửa giá trị của key <i>key APP_CODE_PATH_HOST</i> lại thành <i>../projects</i> (hoặc codes gì đó tuỳ theo thư mục các bạn đã đặt tên).</p>
        <p>Bước hai là vào file <i>default.conf</i> thêm các đoạn code sau vào (thật ra là mình copy từ đoạn gốc)</p>

<pre><code class="nginx">
    server {

        listen <u>81</u> default_server;
        listen [::]:<u>81</u> default_server ipv6only=on;
    
        # For https
        # listen 443 ssl default_server;
        # listen [::]:443 ssl default_server ipv6only=on;
        # ssl_certificate /etc/nginx/ssl/default.crt;
        # ssl_certificate_key /etc/nginx/ssl/default.key;
    
        server_name localhost;
        root /var/www/<u>project_1</u>/public;
        index index.php index.html index.htm;
    
        location / {
                try_files $uri $uri/ /index.php$is_args$args;
        }
    
        location ~ \.php$ {
            try_files $uri /index.php =404;
            fastcgi_pass php-upstream;
            fastcgi_index index.php;
            fastcgi_buffers 16 16k;
            fastcgi_buffer_size 32k;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            #fixes timeouts
            fastcgi_read_timeout 600;
            include fastcgi_params;
        }
    
        location ~ /\.ht {
            deny all;
        }
    
        location /.well-known/acme-challenge/ {
            root /var/www/letsencrypt/;
            log_not_found off;
        }
    }
</code></pre>
<p>Phần <u>81</u> mà mình gạch dưới chính là port mà các bạn dành cho dự án tương ứng. Còn <u>project_1</u> là tên thư mục của dự án đó. Sau khi đã cài đặt trong thế giới "bên trong" thì chúng ta chỉ việc đưa nó ra ngoài bằng cách thêm port mới này trong file <i>docker-compose.yml</i> ở mục ports như sau:</p>
<pre><code class="yml">
    ports:
    - "${NGINX_HOST_HTTP_PORT}:80"
    - "${NGINX_HOST_HTTPS_PORT}:443"
    <u>- "81:81"</u>

</code></pre>
        <p>Lúc này chỉ cần cho chạy lại container là chúng ta có thể vào <i>localhost:81</i> để kiểm tra thành quả rồi. Mỗi lần muốn thêm dự án thì các bạn có thể lặp lại các bước trên. Riêng chổ ports thì các bạn nên thêm key trong file <i>.env</i> nhé. </p>

<pre><code class="yml">
    ports:
    - "${NGINX_HOST_HTTP_PORT}:80"
    - "${NGINX_HOST_HTTPS_PORT}:443"
    - "${NGINX_PROJECT_1_LOCAL_PORT}:${NGINX_PROJECT_1_CONTAINER_PORT}"

</code></pre>
    <p>Còn đây là trong giá trị trong file <i>.env</i></p>
<pre><code class="apache">
    ### NGINX #################################################

    NGINX_PROJECT_1_LOCAL_PORT=81
    NGINX_PROJECT_1_CONTAINER_PORT=81
    
</code></pre>
        <h4>Kết</h4>
        <p>Hy vọng bài hướng dẫn này có ít cho mọi người trong quá phần phát triển các ứng dụng Laravel.</p>
        <div class="blog-detail-comments">
			<div id="disqus_thread"></div>
			<script>
			/**
			*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
			*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
			/*
			var disqus_config = function () {
			this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
			this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
			};
			*/
			(function() { // DON'T EDIT BELOW THIS LINE
			var d = document, s = d.createElement('script');
			s.src = 'https://https-tasynguyen3894-github-io.disqus.com/embed.js';
			s.setAttribute('data-timestamp', +new Date());
			(d.head || d.body).appendChild(s);
			})();
			</script>
			<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
		</div>
	</div>
</div>
<!-- /build:body -->