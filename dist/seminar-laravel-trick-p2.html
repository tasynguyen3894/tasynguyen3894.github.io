<!DOCTYPE html>
<html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Seminar: Nghịch phá một số thứ linh tinh cùng Laravel (phần 2) | Tasy Nguyen</title>
        <!-- build:meta -->
        <link rel="shortcut icon" type="image/png" href="/public/img/css/tasynguyen.png"/>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
        <link rel="stylesheet" href="/public/css/styles.css">
        <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.13.1/build/styles/default.min.css">
        <link rel="alternate" type="application/rss+xml" title="Tasy Nguyen Blog" href="rss.xml">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    </head>
    <body>
        <div class="navbar-fixed home-bg">
            <div class="navbar-content">
                <!-- <div class="navbar-button">
                    <span id="nav-info-toggle">
                        <span class="fa fa-code" ></span> 
                        <span class="toggle-content">Tasy Nguyen</span>
                    </span>
                </div>
                <div class="navbar-button-close" id="nav-info-mobile-close">
                    <span class="fa fa-arrow-left"></span>
                </div> -->
                <div class="navbar-short-info" id="nav-info">
                    <div class="navbar-short-info-avatar">
                        <img src="https://avatars3.githubusercontent.com/u/18634365?s=400&v=4" alt="">
                    </div>
                    <h3>Nguyen Thai Sang</h3>
                    <h4>Web developer</h4>
                    <p>Hello world!</p>
                    <div class="navbar-shor-info-contact">
                        <a class="twitter" target="_blank" href="https://twitter.com/tasyit"><span class="fa fa-twitter"></span></a>
                        <a class="linkedin" target="_blank" href="https://linkedin.com/in/thaisangnguyen3894/"><span class="fa fa-linkedin"></span></a>
                        <a class="github" target="_blank" href="https://github.com/tasynguyen3894/"><span class="fa fa-github"></span></a>
                    </div>
                </div>
                <div class="navbar-quotes" id="navbar-quotes">
                    
<div class="navbar-quotes-content">
    Don't tell people how to do things, tell them what to do and let them surprise you with their results.
</div>
<div class="navbar-quotes-speaker">
    George S. Patton Jr.
</div>

                </div>
            </div>
        </div>
        <div class="container">
            <div class="container-content">
                <!-- <div class="navbar-button">
                    <span class="fa fa-arrow-right" id="nav-info-mobile-open"></span>

                </div> -->
                <div class="navbar-menu">
                    <div class="title-mobile">
                        <a href="index.html">Tasy Nguyen Blog</a>
                        <span id="toggle-button-mb" class="fa fa-bars"></span>
                    </div>
                    <ul id="menu-mobile">
                        <li><a href="index.html">Blog</a></li>
                        <li><a href="product.html">Products</a></li>
                        <li><a href="me.html">Me</a></li>
                        <li><a href="notes.html">Notes</a></li>
                        <li><a href="rss.xml" target="_blank" >RSS</a></li>
                    </ul>
                </div>
                <div class="main-content">
                    
<h1>Seminar: Nghịch phá một số thứ linh tinh cùng Laravel (phần 2)</h1>
<div class="home-content">
	<div class="blog-detail">
		<div class="blog-detail-date">Đăng lúc 11/04/2019</div>
		<div class="tags">
            <span><a href="tags.html?tag=laravel">laravel</a></span>
            <span><a href="tags.html?tag=seminar">seminar</a></span>
		</div>
        <ul class="series">
            <li>Các bài viết trong series</li>
            <li><a href="seminar-laravel-trick-p1.html">Chạy nhiều dự án với Laradock</a></li>
            <li><a class="current" href="seminar-laravel-trick-p2.html">Chạy một ngrok cho nhiều dự án</a></li>
            <!-- <li><a href="toi-da-den-voi-javascript-nhu-the-nao-p3.html">First love</a></li>
            <li><a href="toi-da-den-voi-javascript-nhu-the-nao-p4.html">New Deal</a></li>
            <li><a href="toi-da-den-voi-javascript-nhu-the-nao-p5.html">Nhân sinh hà xứ bất tương phùng</a></li> -->
        </ul>
        
        <h4>Chạy một ngrok cho nhiều dự án</h4>
        <p>Sau khi đã chạy được một Laradock cho nhiều dự án thì chúng ta sẽ nghịch tới một trò khác vui hơn. Đó là dùng một link <b>ngrok</b> cho nhiều dự án. Như đã biết thì nếu không xì tiền ra mua thì mỗi tài khoản của chúng ta chỉ chạy được một link một lúc thôi. Giả sử chúng ta cần hai hoặc ba dự án đều có link https thì sao? Thì trả tiền thôi chứ biết sao giờ :(.</p>
        <p>Đương nhiên nếu đó là cách duy nhất thì mình cũng không rãnh gì mà viết bài giật tít như trên để ăn gạch :v. Ở đây mình sẽ đưa ra một cách có thể giải quyết phần nào vấn đề trên đó là vẫn dùng một link <b>ngrok</b>, nhưng thêm phần thư mục phụ cho mỗi dự án. Ví dụ như:</p>
        <p>
            <i>https://e5bdd7c0.ngrok.io/prject_1</i> với dự án 1 <br>
            <i>https://e5bdd7c0.ngrok.io/prject_2</i> với dự án 2 <br>
            <i>https://e5bdd7c0.ngrok.io/prject_3</i> với dự án 3 <br>
            ...
        </p>
        <p>Để thực hiện điều trên chúng ta sẽ cần làm các việc như sau:</p>
        <ul>
            <li>Cấu hình một tí với nginx</li>
            <li>Cấu hình một số chổ trong dự án Laravel</li>
        </ul>
        <h4>Cấu hình Nginx</h4>
        <p>Đối với nginx thì mình sẽ chơi một cái trò gọi là Proxy pass. Trò nó có nghĩa là khi có một request truy cập với một cổng nào đó trong nginx, cổng đó sẽ đưa toàn bộ request đó qua một nơi khác để xử lý. Sau khi xử lý xong thì sẽ đưa kết quả đó ra cho nơi yêu cầu. Hay đơn giản hơn là chúng ta có thể xem như thanh niên đó giống như một công ty giao hàng vậy. Giả sử bạn là người mua hàng trên một trang web. Sau đó bạn yêu cầu rằng bạn cần lấy một danh sách các sản phẩm trong một đơn hàng. Khi nhận đơn hàng thì công ty này sẽ "điều lính" đến "kho hàng" được cấu hình sẵn và gửi đơn hàng của bạn cho người thủ kho. Bên thủ kho sẽ đưa hàng cho công ty giao hàng. Anh ta sẽ chạy một mạch về giao gói hàng cho bạn.</p>
        <p>Đến đây có thể bạn sẽ thắc mắc là "vậy thì khác quái gì cái bình thường tôi vẫn làm?". Đương nhiên là nếu thế thì không khác. Nhưng giả sử có nhiều kho hàng thì sao? Nếu thế thì lúc yêu cần ngoài đơn hàng chúng ta cần cho công ty đó biết kho hàng cần lấy nửa. Ví dụ như kho hàng quận 1, kho hàng quận 5, Phú Nhuận, Tân Bình, Thủ Đức... Đương nhiên là khi có thông tin đó thì anh giao hàng sẽ chạy một mạch đến kho hàng bạn chỉ định và làm lại giống hệt bước trên.</p>
        <p>Sau ví dụ rất đời thường trên chúng ta có thể hiểu nôm na rằng trang web để bạn gõ đơn hàng chính là link <b>ngrok</b> (chỉ một link duy nhất tương ứng với một trang web thương mại điện tử duy nhất). Đơn hàng chính là request của bạn. Công ty đó  chính là cái cổng nginx sẽ điều phối các request. Tên kho hàng chính là phần <u>/prject_1</u> trong ví dụ phía trên. Các kho hàng chính là các dự án (tương ứng với các port khác nhau). Đương nhiên là các bạn chỉ cần một trang web thương mại điện tử để tương tác với các kho hàng trên tương ứng với việc chỉ một link <b>ngrok</b> cho các dự án khác nhau (chung một con nginx).</p>
        <p>Sau khi nói về ý tưởng, chúng ta sẽ tiến hành cấu hình file <i>default.conf</i> như sau:</p>
<pre><code class="nginx">
    server {
        listen   <u>55</u>;
        listen [::]:<u>55</u>;
        server_name  php-docker.local;

        location <u>/project_1</u> {
            rewrite /<u>project_1</u>/(.*) /$1 break;
            proxy_pass http://localhost:<u>81</u>/;
        }

        location <u>/project_2</u> {
            rewrite /<u>project_2</u>/(.*) /$1 break;
            proxy_pass http://localhost:<u>82</u>/;
        }
    }

</code></pre>
        <p>Nhìn trong đoạn cấu hình trên có thể thấy được <u>project_1</u> và <u>project_2</u> chính là hai phần domain để nhận biết (hay nói theo cách đời thường là tên kho hàng). Còn <u>81</u> và <u>82</u> là port tương ứng của dự án kèo theo domain đó. <u>55</u> chính là port của cổng điều phối. Khi chạy <b>ngrok</b> chúng ta sẽ chạy trên cổng này để nó có thể dựa vào domain mà điều phối đến các dự án kia.</p>
        <h4>Cấu hình do Laravel</h4>
        <p>Sau khi cấu hình cho nginx thì bước kế tiếp sẽ là cấu hình một chút là dự án Laravel. Bước đầu tiên sẽ là thêm đoạn code sau cho file <i>AppServiceProvider</i> ở function <i>boot</i></p>
<pre><code class="php">
    public function boot() {
        if(env('RUN_SUBDIR')) {
            $url = $this->app['url'];
            $url->forceRootUrl(env('APP_URL'));
        }
        // coding...
    }
</code></pre>
        <p>Ở đây có hai key env đó là <i>RUN_SUBDIR</i> và <i>APP_URL</i>. RUN_SUBDIR chính là một cái cờ để xác định có chạy theo chế độ đó (domain phụ) hay không. Còn APP_URL chính là đường dẫn của App ví dụ như <i>https://e5bdd7c0.ngrok.io/prject_1</i>. Chúng ta thêm phần này vào để đảm bảo những request được đưa về sẽ vào thẳng dự án 1 chứ không bị đưa ra root. Ví dụ như khi chúng ra gõ một link đơn giản như sau <i>https://e5bdd7c0.ngrok.io/prject_1/api/products</i> có thể sẽ bị đưa về <i>https://e5bdd7c0.ngrok.io/api/products</i> dẫn đến kết quả không mong muốn.</p>
        <p>Đó là đối với backend, còn nếu app của bạn còn dùng cả frontend thì chúng ta cũng cần một chút táy máy. Thứ nhất đó là thay cái đường đẫn sript hoặc style thành các dạng như bên dưới nhằm không bị dẫn sai link:</p>
<pre><code class="html">
    &lt;link href="{{ URL::asset('bower_component/noty/lib/noty.css') }}" rel="stylesheet">
    &lt;!-- hoặc -->
    &lt;link href="{{ URL::asset(mix('css/main.css')) }}" rel="stylesheet">

</code></pre>
        <p>Đặc biệt nếu bạn sử dụng webpack để build thì cần phải cấu hình thêm một chút ở file <i>webpack.mix.js</i></p>
<pre><code class="javascript">
    mix.setResourceRoot('../')

</code></pre>
        <p>Chúng ta thêm phần đó để khi resource được build xong ra dời ra ngoài một cấp thư mục (tương ứng với việc chúng ta thêm một cấp thư mục trong link <b>ngrok</b> chính).</p>
        <p>Đến đây thì có thể xem là xong việc cấu hình rồi (hiện tại chưa gặp bug :v). Đương nhiên việc này cũng sẽ có những mặc hạn chế của nó, nổi cợm nhất chính là việc session sẽ phải dùng chung (vì chung domain). Nên các bạn cũng nên cân nhắc đến vấn đề này trước khi thực hiện.</p>
        <h4>Kết</h4>
        <p>Phần hướng dẫn đến đây là kết thúc rồi, hy vọng mọi người sẽ có thể nghịch phá thành công một ngrok với nhiều dự án sau bài hướng dẫn này.</p>
        <div class="blog-detail-comments">
			<div id="disqus_thread"></div>
			<script>
			/**
			*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
			*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
			/*
			var disqus_config = function () {
			this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
			this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
			};
			*/
			(function() { // DON'T EDIT BELOW THIS LINE
			var d = document, s = d.createElement('script');
			s.src = 'https://https-tasynguyen3894-github-io.disqus.com/embed.js';
			s.setAttribute('data-timestamp', +new Date());
			(d.head || d.body).appendChild(s);
			})();
			</script>
			<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
		</div>
	</div>
</div>

                </div>
                <footer>
                    <div>Created with <a href="https://github.com/tasynguyen3894/1989stack">1989Stack</a>
                        | <a href="tags.html"><span class="fa fa-tag"></span></a>
                        <a href="https://twitter.com/tasyit"><span class="fa fa-twitter"></span></a>
                        <a href="https://github.com/tasynguyen3894"><span class="fa fa-github"></span></a>
                    </div>
                    <div><a href="/">thaisang.nguyen3894.github.io</a> - <a href="versions.html">Verison 1.2.0</a> &copy 2018</div>
                </footer>
            </div>
        </div>
        <script src="/public/js/main.js"></script>
        <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.13.1/build/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        <!-- build:script -->
    </body>
</html>